// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User can own multiple listings, but each listing is owned by only one user.
// Each listing can have multiple managers, and a user can manage multiple listings.

enum Role {
  User
  Admin
}

// User
model User {
  id                       String        @id @default(auto()) @map("_id") @db.ObjectId
  clerkId                  String        @unique
  stripeId                 String        @unique
  isStripeConnectedAccount Boolean       @default(false)
  role                     Role          @default(User)
  email                    String        @unique
  phoneNo                  String        @unique
  firstName                String
  lastName                 String
  profileImg               String
  dob                      DateTime?
  gender                   Gender?
  country                  String?
  address                  Address? // Grouped address fields
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  // Relationships
  ownedListings            Listing[]     @relation("OwnedListings")
  managedListingIds        String[]      @default([]) @db.ObjectId
  managedListings          Listing[]     @relation("ManagedListings", fields: [managedListingIds], references: [id])
  reviews                  Review[]
  Booking                  Booking[]
  Transaction              Transaction[]
  RoomEvent                RoomEvent[]
}

enum Gender {
  Male
  Female
  Other
}

type Address {
  residence  String
  street     String
  city       String
  province   String
  landmark   String @default("")
  postalCode String
}

// Listing
model Listing {
  id                          String             @id @default(auto()) @map("_id") @db.ObjectId
  name                        String
  type                        String
  email                       String
  phoneNo                     String
  description                 String
  checkInTime                 String
  checkOutTime                String
  createdAt                   DateTime           @default(now())
  updatedAt                   DateTime           @updatedAt
  // Geometry & address
  geometry                    GeoJSON
  address                     ListingAddress
  distanceFrom                DistanceFrom
  // Images, Legal Docs, Policies, Rules & Regulations
  images                      String[]
  legalDocs                   String[]
  coverImage                  String
  taxIN                       String
  taxRates                    TaxRates[]
  isBookNowPayLaterAllowed    Boolean            @default(true)
  checkInRulesAndRestrictions String
  groundRulesAndRestrictions  String
  cancellationPolicy          String
  // Relationships
  owner                       User               @relation("OwnedListings", fields: [ownerId], references: [id])
  ownerId                     String             @db.ObjectId
  managers                    User[]             @relation("ManagedListings", fields: [managerIds], references: [id])
  managerIds                  String[]           @default([]) @db.ObjectId
  rooms                       Room[]
  Booking                     Booking[]
  Transaction                 Transaction[]
  RoomEvent                   RoomEvent[]
  // Amenities
  amenities                   String[]
  // Reviews & Ratings
  reviews                     Review[]
  starRating                  Float // Out of 5, avg of stars for all reviews
  overallRating               Float              @default(7) // Out of 10, 10 being best and 0 being poorest, avg of overallRatings of the same by all reviews
  exploreinnGrade             ExploreinnGrade    @default(Good) //given based on overallRating
  // socials
  socialMediaLinks            SocialMediaLinks[]
  tags                        String[]
  Offer                       Offer[]
}

// Transaction
model Transaction {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  paymentId     String         @unique
  listing       Listing        @relation(fields: [listingId], references: [id])
  listingId     String         @db.ObjectId
  guest         User           @relation(fields: [guestId], references: [id])
  guestId       String         @db.ObjectId
  booking       Booking        @relation(fields: [bookingId], references: [id])
  bookingId     String         @unique @db.ObjectId
  bookingType   BookingType    @default(ONLINE_PAYMENT)
  paymentStatus PaymentStatus
  taxRates      TaxRates[]
  tax           Float
  totalCost     Float
  receiptURL    String?
  paymentMethod BookingType
  card          PaymentMethod?
  chargedAt     DateTime?
  refundedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

type PaymentMethod {
  cardBrand    String
  last4        String
  expMonth     Int
  expYear      Int
  billingName  String
  billingEmail String
  billingPhone String?
}

// Booking
model Booking {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  listing       Listing       @relation(fields: [listingId], references: [id])
  listingId     String        @db.ObjectId
  guest         User          @relation(fields: [guestId], references: [id])
  guestId       String        @db.ObjectId
  checkInDate   DateTime
  checkOutDate  DateTime
  guests        Int
  rooms         BookedRooms[]
  extras        RoomExtra[]
  bookingType   BookingType
  transactionId String?       @db.ObjectId
  transaction   Transaction?
  paymentId     String?
  paymentStatus PaymentStatus
  taxRates      TaxRates[]
  tax           Float
  totalCost     Float
  bookingStatus BookingStatus
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  specialNote   String?       @default("")
  offer         Offer?        @relation("OfferBookings", fields: [offerId], references: [id])
  offerId       String?       @db.ObjectId
}

type BookedRooms {
  roomId    String
  name      String
  rate      Float
  noOfRooms Int
}

enum BookingStatus {
  upcoming
  ongoing
  completed
  cancelled
}

enum BookingType {
  BOOK_NOW_PAY_LATER
  ONLINE_PAYMENT
}

enum PaymentStatus {
  pending
  completed
  cancelled
  requested_refund
  refunded
  charged
}

type GeoJSON {
  type        String  @default("Point") // For GeoJSON type, e.g., "Point"
  coordinates Float[]
}

type ListingAddress {
  street       String
  neighborhood String
  city         String
  state        String
  country      String
  zipCode      String
  fullAddress  String
  landmark     String? @default("") // Optional field
}

type DistanceFrom {
  touristDestinations DistanceFromDestination[]
  airport             DistanceFromDestination
  railwayStation      DistanceFromDestination
  busStop             DistanceFromDestination
}

type DistanceFromDestination {
  name     String
  distance Float
}

enum ExploreinnGrade {
  Excellent
  VeryGood
  Good
  Fair
  Poor
}

type TaxRates {
  name String
  rate Float
}

type SocialMediaLinks {
  name String
  link String
}

// Review
model Review {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  content       String
  stars         Float    @default(0)
  cleanliness   Float    @default(0)
  comfort       Float    @default(0)
  communication Float    @default(0)
  checkIn       Float    @default(0)
  valueForMoney Float    @default(0)
  location      Float    @default(0)
  overallRating Float    @default(0) //avg of above 6 fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  // Relationships
  author        User     @relation(fields: [authorId], references: [id])
  authorId      String   @db.ObjectId
  listing       Listing  @relation(fields: [listingId], references: [id])
  listingId     String   @db.ObjectId
}

// Room
model Room {
  id                      String         @id @default(auto()) @map("_id") @db.ObjectId
  name                    String
  tag                     String
  isAvailable             Boolean
  isDynamicallyPriced     Boolean        @default(false)
  price                   Float //used if dynamic-pricing is enabled, default to basePrice when created
  basePrice               Float //used if dynamic-pricing is disabled
  dynamicPrice            DynamicPrice[]
  totalRoomsAllocated     Int
  currentlyAvailableRooms Int
  maxOccupancy            Int
  area                    Float
  beds                    RoomBed
  isWifiAvailable         Boolean
  isAirConditioned        Boolean
  hasCityView             Boolean
  hasSeaView              Boolean
  perks                   String[]
  extras                  RoomExtra[]
  images                  String[]
  roomEventIds            String[]       @default([]) @db.ObjectId
  roomEvents              RoomEvent[]    @relation("RoomEvents", fields: [roomEventIds], references: [id])
  coverImage              String
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  // Relationships
  listing                 Listing        @relation(fields: [listingId], references: [id])
  listingId               String         @db.ObjectId
}

type RoomBed {
  type  String
  count Int
}

type DynamicPrice {
  date  DateTime
  price Float
}

type RoomExtra {
  name String
  cost Float
}

// Room Event
model RoomEvent {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  type      RoomEventType
  listing   Listing       @relation(fields: [listingId], references: [id])
  listingId String        @db.ObjectId

  startDate   DateTime
  endDate     DateTime
  author      User          @relation(fields: [authorId], references: [id])
  authorId    String        @db.ObjectId
  priceChange PriceChange[]
  highDemand  HighDemand[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  rooms       Room[]        @relation("RoomEvents", fields: [roomIds], references: [id])
  roomIds     String[]      @default([]) @db.ObjectId
}

enum RoomEventType {
  HighDemand
  PriceChange
  BookingClosed
}

type PriceChange {
  newPrice Float
  roomId   String
  roomName String
}

type HighDemand {
  priceIncrementPercentage Float
  roomId                   String
  roomName                 String
}

// Offers
model Offer {
  id                   String     @id @default(auto()) @map("_id") @db.ObjectId
  scope                offerScope
  name                 String
  description          String
  couponCode           String
  isActive             Boolean    @default(true)
  startDate            DateTime
  endDate              DateTime
  type                 offerType
  flatDiscount         Float?     @default(0)
  percentageDiscount   Float?     @default(0)
  minimumBookingAmount Float?     @default(0)
  maxDiscountAmount    Float?     @default(0)
  redeemForPoints      Int?       @default(0)
  bookings             Booking[]  @relation("OfferBookings")
  bookingIds           String[]   @default([]) @db.ObjectId
  listingId            String?    @db.ObjectId
  listing              Listing?   @relation(fields: [listingId], references: [id])
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

enum offerScope {
  ListingWide
  AppWide
}

enum offerType {
  Percentage_Discount
  Flat_Discount
  Extra_Perks
}
